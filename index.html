<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HK Cube Drafts</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --muted:#9aa7bf; --accent:#60a5fa; --text:#e6eef8;
      --light-bg:#f6f8fb; --light-card:#ffffff; --light-text:#0b1220; --light-muted:#475569;
      --danger: #ff6b6b; --success: #4ade80;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);color:var(--text);padding:18px;box-sizing:border-box;}
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px; font-weight: 700; letter-spacing: -0.5px;}
    .top-actions{display:flex;gap:8px;align-items:center}
    
    button{
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      color:var(--text);
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button:hover { background: rgba(255,255,255,0.1); }
    button.primary { background: var(--accent); color: #000; border:none; font-weight: 600; }
    button.primary:hover { opacity: 0.9; }
    button.danger { border-color:var(--danger); color:var(--danger); }
    button.danger:hover { background: rgba(255, 107, 107, 0.1); }

    input,select,textarea{
      padding:8px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.2);
      color:var(--text);
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); border-color: transparent; }

    .card{background:var(--card); padding:16px; border-radius:12px; margin-bottom:16px; border: 1px solid rgba(255,255,255,0.05);}
    
    table{width:100%;border-collapse:collapse; font-size: 14px;}
    th{text-align:left; color: var(--muted); font-weight: 500; font-size: 12px; text-transform: uppercase; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.05);}
    td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03);}
    tr:last-child td { border-bottom: none; }
    .list-row{cursor:pointer; transition: background 0.1s;}
    .list-row:hover{background:rgba(255,255,255,0.02);}
    
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;}
    .tab{
      padding:6px 12px;
      border-radius:20px;
      background:transparent;
      border:1px solid transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 13px;
    }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .tab.active{background:rgba(96, 165, 250, 0.15); color:var(--accent); border-color: rgba(96, 165, 250, 0.2); font-weight: 500;}
    
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    .full{grid-column:1/-1}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .hidden{display:none !important}
    .flex{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .dark-toggle{display:flex;align-items:center;gap:6px}

    /* Modals & Toasts */
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(2px);
      z-index: 999; display: flex; align-items: center; justify-content: center;
    }
    .modal-content {
      background: var(--card); border: 1px solid rgba(255,255,255,0.1);
      width: 90%; max-width: 500px; padding: 20px; border-radius: 12px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .toast {
      position: fixed; bottom: 20px; right: 20px; background: var(--card);
      border: 1px solid var(--accent); color: var(--text); padding: 12px 20px;
      border-radius: 8px; z-index: 1000; animation: slideIn 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width:900px){ .grid{grid-template-columns:1fr} .top-actions{flex-wrap:wrap} }
    
    /* Light mode overrides */
    .light body{background:var(--light-bg);color:var(--light-text)}
    .light .card{background:var(--light-card); box-shadow:0 2px 8px rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.05);}
    .light input, .light select, .light textarea{background:rgba(0,0,0,0.03); color:var(--light-text); border-color:rgba(0,0,0,0.1)}
    .light button{border-color:rgba(0,0,0,0.1); color:var(--light-text); background: white;}
    .light button:hover { background: #f1f5f9; }
    .light button.primary { background: var(--accent); color: white; }
    .light .tab { color: var(--light-muted); }
    .light .tab:hover { background: rgba(0,0,0,0.05); color: var(--light-text); }
    .light .tab.active { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
    .light th { color: var(--light-muted); border-bottom-color: rgba(0,0,0,0.05); }
    .light td { border-bottom-color: rgba(0,0,0,0.05); }
    .light .list-row:hover { background: rgba(0,0,0,0.02); }
    .light .modal-content { background: var(--light-card); border-color: rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAeQ_3kQMT05vyDJh_GzrYXkO230DAdmIA",
    authDomain: "draft-comp.firebaseapp.com",
    projectId: "draft-comp",
    storageBucket: "draft-comp.firebasestorage.app",
    messagingSenderId: "659823969862",
    appId: "1:659823969862:web:cde4264c1c2930061dec47",
    measurementId: "G-ZK96LVQ63R"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
  <div class="container" id="app">
    <header>
      <div>
        <h1>HK Cube Drafts</h1>
        <div class="muted small">Cloud-synced Competition Manager</div>
      </div>

      <div class="top-actions">
        <div class="dark-toggle">
          <label class="small muted" style="cursor: pointer;">
            <input id="darkToggle" type="checkbox" checked /> Dark Mode
          </label>
        </div>
        <div id="authArea" class="flex">
          <!-- Simulation Login -->
          <input id="simPassword" type="password" placeholder="Pass: admin" style="width:120px" />
          <button id="signinBtn">Login</button>
          <div id="adminControls" class="hidden flex">
            <span class="small" style="color:var(--success)">Admin Mode</span>
            <button id="signoutBtn" class="danger" style="padding: 4px 8px; font-size: 11px;">Exit</button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div id="mainContent" class="grid">
        <!-- Left: list & details -->
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>Drafted Competitions</strong>
                <div class="muted small">Real-time updates across devices</div>
              </div>
              <div>
                <button id="newCompBtn" class="primary">+ New Draft</button>
              </div>
            </div>

            <div id="listArea" style="margin-top:12px">
              <table id="compsTable">
                <thead><tr><th>Name</th><th>Date</th><th>Venue</th></tr></thead>
                <tbody id="compsTbody"></tbody>
              </table>
              <div id="loadingMsg" class="muted small" style="text-align:center; padding: 20px;">Loading competitions...</div>
              <div id="emptyMsg" class="hidden muted small" style="text-align:center; padding: 20px;">No competitions found. Create one!</div>
            </div>
          </div>

          <div id="compCard" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 12px;">
              <div>
                <h2 id="compName" style="margin:0; font-size: 18px;"></h2>
                <div id="compMeta" class="muted small"></div>
              </div>
              <div id="adminActions" class="flex hidden">
                <button id="cloneCompBtn" title="Clone Draft">Clone</button>
                <button id="deleteCompBtn" class="danger" title="Delete Draft">Delete</button>
              </div>
            </div>

            <div class="tabs" id="tabs"></div>

            <div id="tabContent" style="margin-top:16px; min-height: 200px;"></div>
          </div>
        </div>

        <!-- Right: quick info / admin settings -->
        <div>
          <div class="card">
            <strong>Status</strong>
            <div id="userInfo" class="muted small" style="margin-top: 4px;">Viewer Mode</div>
            <div id="connectionStatus" class="small" style="margin-top: 4px; color: var(--success)">Connected to Cloud</div>
          </div>

          <div class="card">
            <strong>Help</strong>
            <div class="muted small" style="line-height: 1.5;">
              <p style="margin-top:4px">Data is stored in a public cloud database. Anyone with this link can view updates.</p>
              <p>To edit, sign in with password: <strong>admin</strong></p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Custom Alert/Modal Container -->
  <div id="modalContainer"></div>
  <div id="toastContainer"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { 
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { 
    getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // --- CONFIG ---
  // Using the environment's provided configuration
  const firebaseConfig = JSON.parse(__firebase_config);
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  // --- APP STATE ---
  let isAdmin = false;
  let currentCompId = null;
  let currentUser = null;
  
  // Data caches
  let competitions = [];
  let events = [];
  let schedules = [];
  let budgets = [];
  let checklist = [];
  let staff = [];
  let freeTabs = [];

  // Listeners
  let unsubComps = null;
  let unsubDetails = []; // Array of unsubscribe functions for sub-collections

  // --- CONSTANTS ---
  const EVENTS_LIST = ['3x3','2x2','4x4','5x5','6x6','7x7','3BLD','FMC','3x3 OH','Clock','Megaminx','Pyraminx','Skewb','Square-1','4BLD','5BLD','MBLD'];
  const TAB_LIST = ['Home','Event','Schedule','Draft Budget','Actual Budget','Checklist','Staff','Travel','Prize','Remarks'];

  // --- UI UTILS ---
  function showToast(msg) {
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    document.getElementById('toastContainer').appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  function showConfirm(msg, onConfirm) {
    const backdrop = document.createElement('div');
    backdrop.className = 'overlay';
    backdrop.innerHTML = `
      <div class="modal-content">
        <h3 style="margin-top:0">Confirm</h3>
        <p>${msg}</p>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
          <button id="confCancel">Cancel</button>
          <button id="confOk" class="primary">Confirm</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    backdrop.querySelector('#confCancel').onclick = () => backdrop.remove();
    backdrop.querySelector('#confOk').onclick = () => {
      onConfirm();
      backdrop.remove();
    };
  }

  function showPrompt(title, label, defaultValue = '', onOk) {
    const backdrop = document.createElement('div');
    backdrop.className = 'overlay';
    backdrop.innerHTML = `
      <div class="modal-content">
        <h3 style="margin-top:0">${title}</h3>
        <div class="col">
          <label class="small muted">${label}</label>
          <input id="promptInput" value="${defaultValue}" style="width:100%">
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
          <button id="prmptCancel">Cancel</button>
          <button id="prmptOk" class="primary">Save</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    const input = backdrop.querySelector('#promptInput');
    input.focus();
    
    backdrop.querySelector('#prmptCancel').onclick = () => backdrop.remove();
    backdrop.querySelector('#prmptOk').onclick = () => {
      onOk(input.value);
      backdrop.remove();
    };
    input.addEventListener('keyup', (e) => {
      if(e.key === 'Enter') backdrop.querySelector('#prmptOk').click();
    });
  }

  // --- AUTH LOGIC (Simulated Admin) ---
  const signinBtn = document.getElementById('signinBtn');
  const signoutBtn = document.getElementById('signoutBtn');
  const simPassword = document.getElementById('simPassword');
  const adminControls = document.getElementById('adminControls');
  const userInfo = document.getElementById('userInfo');

  // Initialize Auth
  const initAuth = async () => {
    try {
      // Use provided token if available, otherwise anonymous
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    } catch (error) {
      console.error("Auth Error:", error);
      document.getElementById('connectionStatus').textContent = "Connection Failed";
      document.getElementById('connectionStatus').style.color = "var(--danger)";
    }
  };
  
  initAuth();

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      initDataListeners(); // Start fetching data once connected
    }
  });

  // Client-side Admin Toggle
  signinBtn.addEventListener('click', () => {
    const pass = simPassword.value;
    if (pass === 'admin') {
      setAdminState(true);
      simPassword.value = '';
      showToast('Welcome, Admin');
    } else {
      showToast('Incorrect password. Try "admin"');
    }
  });

  signoutBtn.addEventListener('click', () => {
    setAdminState(false);
    showToast('Signed out of Admin mode');
  });

  function setAdminState(state) {
    isAdmin = state;
    if (isAdmin) {
      simPassword.classList.add('hidden');
      signinBtn.classList.add('hidden');
      adminControls.classList.remove('hidden');
      userInfo.textContent = "Admin Mode";
      userInfo.style.color = "var(--accent)";
    } else {
      simPassword.classList.remove('hidden');
      signinBtn.classList.remove('hidden');
      adminControls.classList.add('hidden');
      userInfo.textContent = "Viewer Mode";
      userInfo.style.color = "var(--muted)";
    }
    // Refresh UI
    renderCompsList();
    if (currentCompId) renderCompDetails();
  }

  // --- FIRESTORE DATA HANDLING ---
  
  const getCollRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);

  function initDataListeners() {
    // Listen to Competitions
    const q = query(getCollRef('competitions')); 
    unsubComps = onSnapshot(q, (snapshot) => {
      competitions = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
      // Sort by start_date client-side
      competitions.sort((a,b) => (a.start_date || '') > (b.start_date || '') ? 1 : -1);
      
      document.getElementById('loadingMsg').classList.add('hidden');
      if(competitions.length === 0) document.getElementById('emptyMsg').classList.remove('hidden');
      else document.getElementById('emptyMsg').classList.add('hidden');
      
      renderCompsList();
      
      // If currently viewing a comp, refresh its header data
      if (currentCompId) {
        const c = competitions.find(x => x.id === currentCompId);
        if (c) updateHeader(c);
        else closeComp(); // Comp was deleted
      }
    }, (err) => {
      console.error("Firestore Error:", err);
    });

    // Listeners for all collections (simple implementation for this scale)
    const collections = ['events', 'schedules', 'budgets', 'checklist', 'staff', 'free_tabs'];
    collections.forEach(colName => {
      unsubDetails.push(onSnapshot(getCollRef(colName), (snap) => {
        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
        
        // Update local cache
        if (colName === 'events') events = data;
        if (colName === 'schedules') {
           schedules = data;
           schedules.sort((a,b) => (a.start_time || '') > (b.start_time || '') ? 1 : -1);
        }
        if (colName === 'budgets') budgets = data;
        if (colName === 'checklist') checklist = data;
        if (colName === 'staff') staff = data;
        if (colName === 'free_tabs') freeTabs = data;

        // Refresh Active Tab if applicable
        if (currentCompId) {
          const t = getCurrentTab();
          if (colName === 'events' && t === 'Event') renderEventTab();
          if (colName === 'schedules' && t === 'Schedule') renderScheduleTab();
          if (colName === 'budgets' && (t === 'Draft Budget' || t === 'Actual Budget')) {
             if(t === 'Draft Budget') renderDraftBudgetTab();
             else renderActualBudgetTab();
          }
          if (colName === 'checklist' && t === 'Checklist') renderChecklistTab();
          if (colName === 'staff' && t === 'Staff') renderStaffTab();
          if (colName === 'free_tabs' && ['Travel','Prize','Remarks'].includes(t)) renderFreeTab(t);
        }
      }));
    });
  }

  // --- UI RENDERING ---

  const compsTbody = document.getElementById('compsTbody');
  
  function renderCompsList() {
    compsTbody.innerHTML = '';
    competitions.forEach(c => {
      const tr = document.createElement('tr');
      tr.className = 'list-row';
      tr.innerHTML = `
        <td style="font-weight:500; color:var(--text)">${escapeHtml(c.name||'Untitled')}</td>
        <td class="muted">${c.start_date || '-'}</td>
        <td class="muted">${escapeHtml(c.venue || '-')}</td>
      `;
      tr.addEventListener('click', () => openCompetition(c.id));
      if (currentCompId === c.id) tr.style.background = 'rgba(96, 165, 250, 0.1)';
      compsTbody.appendChild(tr);
    });
  }

  function openCompetition(id) {
    currentCompId = id;
    renderCompsList(); 
    renderCompDetails();
  }
  
  function renderCompDetails() {
    const c = competitions.find(x => x.id === currentCompId);
    if (!c) return;

    document.getElementById('compCard').classList.remove('hidden');
    updateHeader(c);
    renderTabs();
    switchTab(activeTab); // Re-render current tab
  }

  function closeComp() {
    currentCompId = null;
    document.getElementById('compCard').classList.add('hidden');
    renderCompsList();
  }

  function updateHeader(c) {
    document.getElementById('compName').textContent = c.name || 'Untitled';
    document.getElementById('compMeta').textContent = `${c.start_date || 'TBD'} — ${c.end_date || 'TBD'} · ${c.venue || 'No Venue'}`;
    
    const adminActions = document.getElementById('adminActions');
    if (isAdmin) adminActions.classList.remove('hidden');
    else adminActions.classList.add('hidden');
  }

  const tabsEl = document.getElementById('tabs');
  let activeTab = 'Home';

  function getCurrentTab() { return activeTab; }

  function renderTabs() {
    tabsEl.innerHTML = '';
    TAB_LIST.forEach(t => {
      // Hide Actual Budget for viewers
      if (t === 'Actual Budget' && !isAdmin) return;

      const btn = document.createElement('button');
      btn.className = 'tab' + (t === activeTab ? ' active' : '');
      btn.textContent = t;
      btn.addEventListener('click', () => switchTab(t));
      tabsEl.appendChild(btn);
    });
  }

  function switchTab(t) {
    activeTab = t;
    renderTabs();
    
    const content = document.getElementById('tabContent');
    content.innerHTML = ''; // Clear

    if (t === 'Home') renderHomeTab();
    else if (t === 'Event') renderEventTab();
    else if (t === 'Schedule') renderScheduleTab();
    else if (t === 'Draft Budget') renderDraftBudgetTab();
    else if (t === 'Actual Budget') renderActualBudgetTab();
    else if (t === 'Checklist') renderChecklistTab();
    else if (t === 'Staff') renderStaffTab();
    else renderFreeTab(t);
  }

  // --- TAB CONTENT ---

  function renderHomeTab() {
    const c = competitions.find(x => x.id === currentCompId);
    if(!c) return;
    const isEdit = isAdmin; 
    const disabled = isEdit ? '' : 'disabled';
    const inputStyle = isEdit ? '' : 'border:none; background:transparent; padding:0;';

    const html = `
      <div class="grid full">
        <div class="col">
          <div class="card" style="background:rgba(0,0,0,0.1)">
            <label class="small muted">Competition Name</label>
            <input id="nameInput" value="${escapeHtml(c.name||'')}" ${disabled} style="${inputStyle}; font-size:16px; font-weight:600; width:100%" />
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
              <div>
                <label class="small muted">Start Date</label>
                <input id="startInput" type="date" value="${c.start_date||''}" ${disabled} style="width:100%" />
              </div>
              <div>
                <label class="small muted">End Date</label>
                <input id="endInput" type="date" value="${c.end_date||''}" ${disabled} style="width:100%" />
              </div>
            </div>

            <label class="small muted" style="margin-top:10px">Venue Name</label>
            <input id="venueInput" value="${escapeHtml(c.venue||'')}" ${disabled} style="width:100%" />

            <label class="small muted" style="margin-top:10px">Full Address</label>
            <input id="addressInput" value="${escapeHtml(c.address||'')}" ${disabled} style="width:100%" />

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
              <div>
                 <label class="small muted">Competitor Limit</label>
                 <input id="limitInput" type="number" value="${c.competitor_limit||''}" ${disabled} style="width:100%" />
              </div>
              <div>
                 <label class="small muted">Base Fee</label>
                 <input id="baseFeeInput" type="number" value="${c.base_fee||''}" ${disabled} style="width:100%" />
              </div>
            </div>
            
            ${isEdit ? '<div style="margin-top:16px; text-align:right"><button id="saveHomeBtn" class="primary">Save Changes</button></div>' : ''}
          </div>
        </div>
      </div>
    `;
    document.getElementById('tabContent').innerHTML = html;

    if(isEdit) {
      document.getElementById('saveHomeBtn').addEventListener('click', async () => {
        const payload = {
          name: document.getElementById('nameInput').value.trim(),
          start_date: document.getElementById('startInput').value || null,
          end_date: document.getElementById('endInput').value || null,
          venue: document.getElementById('venueInput').value.trim(),
          address: document.getElementById('addressInput').value.trim(),
          competitor_limit: parseInt(document.getElementById('limitInput').value) || 0,
          base_fee: parseFloat(document.getElementById('baseFeeInput').value) || 0,
        };
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'competitions', currentCompId), payload);
          showToast('Competition details saved!');
        } catch(e) { showToast('Error saving: ' + e.message); }
      });
    }
  }

  function renderEventTab() {
    const compEvents = events.filter(e => e.competition_id === currentCompId);
    
    const container = document.createElement('div');
    container.className = 'col';
    
    if (isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Event';
      addBtn.className = 'primary';
      addBtn.style.width = 'fit-content';
      addBtn.addEventListener('click', () => openEventEditor());
      container.appendChild(addBtn);
    }

    const table = document.createElement('table');
    table.innerHTML = `<thead><tr><th>Event</th><th>Rounds</th><th>Format</th><th>Time Limit</th><th>Cutoff</th>${isAdmin ? '<th>Actions</th>' : ''}</tr></thead>`;
    const tbody = document.createElement('tbody');

    if (compEvents.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center; padding:20px">No events added yet.</td></tr>`;
    }

    compEvents.forEach(ev => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span style="font-weight:600">${escapeHtml(ev.event_code)}</span></td>
        <td>${ev.rounds}</td>
        <td>${escapeHtml(ev.format||'')}</td>
        <td>${escapeHtml(ev.time_limit||'-')}</td>
        <td>${escapeHtml(ev.cutoff||'-')}</td>
        ${isAdmin ? `<td>
          <div class="flex">
             <button class="editEv small">Edit</button>
             <button class="delEv danger small">×</button>
          </div>
        </td>` : ''}
      `;
      if (isAdmin) {
        tr.querySelector('.editEv').addEventListener('click', () => openEventEditor(ev));
        tr.querySelector('.delEv').addEventListener('click', async () => {
          showConfirm(`Delete ${ev.event_code}?`, async () => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', ev.id));
          });
        });
      }
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
    document.getElementById('tabContent').appendChild(container);
  }

  function renderScheduleTab() {
    const compSched = schedules.filter(s => s.competition_id === currentCompId);
    const container = document.createElement('div');
    container.className = 'col';

    if (isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Schedule Item';
      addBtn.className = 'primary';
      addBtn.style.width = 'fit-content';
      addBtn.addEventListener('click', async () => {
        showPrompt('Add Item', 'Start time (e.g. 2024-01-01T09:00)', '', async (start) => {
             if(!start) return;
             await addDoc(getCollRef('schedules'), {
               competition_id: currentCompId,
               day: 1, // Default, can be edited
               start_time: start,
               end_time: '',
               rundown: 'New Activity'
             });
        });
      });
      container.appendChild(addBtn);
    }

    // Group by day
    const days = {};
    compSched.forEach(s => {
      const d = s.day || 1;
      if(!days[d]) days[d] = [];
      days[d].push(s);
    });

    Object.keys(days).sort().forEach(dayNum => {
      const dayCard = document.createElement('div');
      dayCard.className = 'card';
      dayCard.innerHTML = `<strong style="color:var(--accent)">Day ${dayNum}</strong>`;
      
      const t = document.createElement('table');
      t.innerHTML = `<thead><tr><th>Time</th><th>Activity</th>${isAdmin ? '<th style="width:50px"></th>' : ''}</tr></thead>`;
      const tb = document.createElement('tbody');
      
      days[dayNum].forEach(row => {
        const timeStr = row.start_time ? new Date(row.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        const endTimeStr = row.end_time ? new Date(row.end_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="white-space:nowrap; width:140px">${timeStr} ${endTimeStr ? '- ' + endTimeStr : ''}</td>
          <td>${escapeHtml(row.rundown||'')}</td>
          ${isAdmin ? `<td><button class="delSch danger small">×</button></td>` : ''}
        `;
        if (isAdmin) {
          tr.querySelector('.delSch').addEventListener('click', async () => {
             showConfirm('Remove this schedule item?', async () => {
               await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedules', row.id));
             });
          });
        }
        tb.appendChild(tr);
      });
      t.appendChild(tb);
      dayCard.appendChild(t);
      container.appendChild(dayCard);
    });
    
    if(compSched.length === 0) {
      container.innerHTML += '<div class="muted small">No schedule items yet.</div>';
    }

    document.getElementById('tabContent').appendChild(container);
  }

  function renderDraftBudgetTab() {
    // Simple password gate for draft budget (Client side only for this demo)
    if (!isAdmin) {
      const storedGate = sessionStorage.getItem('budget_unlocked');
      if (!storedGate) {
        document.getElementById('tabContent').innerHTML = `
          <div class="col" style="align-items:center; margin-top:40px">
            <div class="muted small">Restricted Area</div>
            <div class="flex">
              <input id="budgetPass" type="password" placeholder="Pass: money" />
              <button id="unlockBudgetBtn">Unlock</button>
            </div>
          </div>
        `;
        document.getElementById('unlockBudgetBtn').addEventListener('click', () => {
          if(document.getElementById('budgetPass').value === 'money') {
            sessionStorage.setItem('budget_unlocked', 'true');
            renderDraftBudgetTab();
          } else {
            showToast('Wrong password');
          }
        });
        return;
      }
    }

    renderBudgetTable('draft');
  }

  function renderActualBudgetTab() {
    renderBudgetTable('actual');
  }

  function renderBudgetTable(kind) {
    const items = budgets.filter(b => b.competition_id === currentCompId && b.kind === kind);
    const container = document.createElement('div');
    container.className = 'col';
    
    if (isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Item';
      addBtn.className = 'primary';
      addBtn.style.width = 'fit-content';
      addBtn.addEventListener('click', async () => {
        showPrompt('New Item', 'Description', 'Venue Rent', async (desc) => {
            if(!desc) return;
            // Add directly with 0 amount, let them edit
            await addDoc(getCollRef('budgets'), {
               competition_id: currentCompId,
               kind: kind,
               item_type: 'expense',
               description: desc,
               amount: 0
            });
        });
      });
      container.appendChild(addBtn);
    }

    const card = document.createElement('div');
    card.className = 'card';
    
    // Calculate total
    const income = items.filter(x => x.item_type === 'income').reduce((a,b) => a + (b.amount||0), 0);
    const expense = items.filter(x => x.item_type !== 'income').reduce((a,b) => a + (b.amount||0), 0);
    const net = income - expense;
    
    card.innerHTML = `
      <div style="display:flex; gap:20px; margin-bottom:15px; font-size:14px;">
        <div style="color:var(--success)">Income: $${income.toFixed(2)}</div>
        <div style="color:var(--danger)">Expenses: $${expense.toFixed(2)}</div>
        <div style="font-weight:bold; color: ${net >= 0 ? 'var(--text)' : 'var(--danger)'}">Net: $${net.toFixed(2)}</div>
      </div>
    `;

    const t = document.createElement('table');
    t.innerHTML = `<thead><tr><th>Type</th><th>Description</th><th>Amount</th>${isAdmin ? '<th></th>' : ''}</tr></thead>`;
    const tb = document.createElement('tbody');
    
    items.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-transform:capitalize" class="${b.item_type === 'income' ? '' : 'muted'}">${escapeHtml(b.item_type)}</td>
        <td>${escapeHtml(b.description)}</td>
        <td>$${(b.amount||0).toFixed(2)}</td>
        ${isAdmin ? `<td><button class="delBud danger small">×</button></td>` : ''}
      `;
      if(isAdmin) {
        tr.querySelector('.delBud').addEventListener('click', async() => {
           showConfirm('Delete budget row?', async () => {
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'budgets', b.id));
           });
        });
      }
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    card.appendChild(t);
    container.appendChild(card);
    
    document.getElementById('tabContent').appendChild(container);
  }

  function renderChecklistTab() {
    const items = checklist.filter(c => c.competition_id === currentCompId);
    const container = document.createElement('div');
    container.className = 'col';

    if(isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Task';
      addBtn.className = 'primary';
      addBtn.style.width='fit-content';
      addBtn.addEventListener('click', async () => {
        showPrompt('New Task', 'Task Name', '', async (item) => {
            if(!item) return;
            await addDoc(getCollRef('checklist'), {
              competition_id: currentCompId,
              item,
              person_in_charge: '',
              progress: 'Pending'
            });
        });
      });
      container.appendChild(addBtn);
    }

    const table = document.createElement('table');
    table.innerHTML = `<thead><tr><th>Status</th><th>Task</th><th>Owner</th>${isAdmin ? '<th></th>' : ''}</tr></thead>`;
    const tb = document.createElement('tbody');

    items.forEach(it => {
      const statusColor = it.progress === 'Done' ? 'var(--success)' : (it.progress === 'WIP' ? 'orange' : 'var(--muted)');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="width:100px; cursor:pointer; color:${statusColor}; font-weight:600" class="status-cell">${it.progress}</td>
        <td>${escapeHtml(it.item)}</td>
        <td class="muted">${escapeHtml(it.person_in_charge||'')}</td>
        ${isAdmin ? '<td><button class="delIt danger small">×</button></td>' : ''}
      `;
      
      // Allow status toggle for everyone or just admin? Usually just admin, but let's allow everyone to "check off" for collab
      if(isAdmin) {
        tr.querySelector('.status-cell').addEventListener('click', async () => {
          const next = it.progress === 'Pending' ? 'WIP' : (it.progress === 'WIP' ? 'Done' : 'Pending');
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', it.id), { progress: next });
        });
        
        tr.querySelector('.delIt').addEventListener('click', async () => {
           showConfirm('Delete task?', async () => {
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', it.id));
           });
        });
      }
      tb.appendChild(tr);
    });

    table.appendChild(tb);
    container.appendChild(table);
    document.getElementById('tabContent').appendChild(container);
  }

  function renderStaffTab() {
    const compStaff = staff.filter(s => s.competition_id === currentCompId);
    const container = document.createElement('div');
    container.className = 'col';

    if(isAdmin) {
      const addBtn = document.createElement('button');
      addBtn.textContent = '+ Add Staff';
      addBtn.className = 'primary';
      addBtn.style.width='fit-content';
      addBtn.addEventListener('click', async () => {
        showPrompt('New Staff', 'Name', '', async (name) => {
            if(!name) return;
            await addDoc(getCollRef('staff'), { competition_id: currentCompId, name, role: 'Staff' });
        });
      });
      container.appendChild(addBtn);
    }

    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
    grid.style.gap = '10px';

    compStaff.forEach(s => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.marginBottom = '0';
      card.innerHTML = `
        <div style="font-weight:600">${escapeHtml(s.name)}</div>
        <div class="muted small">${escapeHtml(s.role)}</div>
        ${isAdmin ? '<button class="delSt danger small" style="margin-top:8px; width:100%">Remove</button>' : ''}
      `;
      if(isAdmin) {
        card.querySelector('.delSt').addEventListener('click', async () => {
          showConfirm('Remove staff member?', async () => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', s.id));
          });
        });
      }
      grid.appendChild(card);
    });

    container.appendChild(grid);
    document.getElementById('tabContent').appendChild(container);
  }

  function renderFreeTab(tabName) {
    // Find existing doc or use empty
    const docData = freeTabs.find(f => f.competition_id === currentCompId && f.tab_name === tabName);
    
    const container = document.createElement('div');
    container.className = 'col';

    if (isAdmin) {
      const ta = document.createElement('textarea');
      ta.rows = 15;
      ta.style.width = '100%';
      ta.value = docData ? docData.content : '';
      ta.placeholder = `Write details about ${tabName} here...`;
      
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save Content';
      saveBtn.className = 'primary';
      saveBtn.style.width = 'fit-content';
      
      saveBtn.addEventListener('click', async () => {
        if (docData) {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'free_tabs', docData.id), { content: ta.value });
        } else {
          await addDoc(getCollRef('free_tabs'), { competition_id: currentCompId, tab_name: tabName, content: ta.value });
        }
        showToast('Saved!');
      });
      
      container.appendChild(ta);
      container.appendChild(saveBtn);
    } else {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.whiteSpace = 'pre-wrap';
      div.textContent = docData ? docData.content : 'No information yet.';
      container.appendChild(div);
    }

    document.getElementById('tabContent').appendChild(container);
  }


  // --- TOP LEVEL ACTIONS ---

  document.getElementById('newCompBtn').addEventListener('click', async () => {
    if (!isAdmin) { showToast('Please login as admin first (Pass: admin)'); return; }
    showPrompt('New Competition', 'Competition Name', '', async (name) => {
        if(name) {
           const res = await addDoc(getCollRef('competitions'), { name, created_at: new Date().toISOString() });
           openCompetition(res.id);
        }
    });
  });

  document.getElementById('deleteCompBtn').addEventListener('click', async () => {
    showConfirm('Delete this entire draft? This cannot be undone.', async () => {
      // In a real app we would delete sub-collections too, 
      // but Firestore handles orphaned docs fine for this scale.
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'competitions', currentCompId));
      closeComp();
    });
  });
  
  document.getElementById('cloneCompBtn').addEventListener('click', async () => {
     showConfirm('Clone this competition?', async () => {
        const c = competitions.find(x => x.id === currentCompId);
        const newItem = { ...c };
        delete newItem.id;
        newItem.name = newItem.name + ' (Clone)';
        const res = await addDoc(getCollRef('competitions'), newItem);
        openCompetition(res.id);
     });
  });

  document.getElementById('darkToggle').addEventListener('change', (e) => {
    if(e.target.checked) document.documentElement.classList.remove('light');
    else document.documentElement.classList.add('light');
  });

  // Event Editor Modal
  function openEventEditor(ev = null) {
    const backdrop = document.createElement('div');
    backdrop.className = 'overlay';
    const content = document.createElement('div');
    content.className = 'modal-content';
    
    content.innerHTML = `
      <h3>${ev ? 'Edit' : 'Add'} Event</h3>
      <div class="col">
        <label class="small muted">Event Code</label>
        <select id="evCode" style="width:100%">
          ${EVENTS_LIST.map(e => `<option value="${e}" ${ev && ev.event_code === e ? 'selected' : ''}>${e}</option>`).join('')}
        </select>
        
        <label class="small muted">Rounds</label>
        <input type="number" id="evRounds" value="${ev ? ev.rounds : 1}" min="1" max="4">
        
        <label class="small muted">Format</label>
        <select id="evFormat" style="width:100%">
           <option>Average of 5</option>
           <option>Best of 3</option>
           <option>Mean of 3</option>
           <option>Best of 1</option>
        </select>
        
        <label class="small muted">Time Limit</label>
        <input id="evLimit" value="${ev ? ev.time_limit || '' : ''}" placeholder="10:00.00">
        
        <label class="small muted">Cutoff</label>
        <input id="evCutoff" value="${ev ? ev.cutoff || '' : ''}" placeholder="3:00.00">
        
        <div style="display:flex; gap:10px; margin-top:10px">
           <button id="cancelEvBtn" style="flex:1">Cancel</button>
           <button id="saveEvBtn" class="primary" style="flex:1">Save</button>
        </div>
      </div>
    `;
    
    backdrop.appendChild(content);
    document.body.appendChild(backdrop);
    
    if(ev && ev.format) content.querySelector('#evFormat').value = ev.format;

    content.querySelector('#cancelEvBtn').onclick = () => backdrop.remove();
    content.querySelector('#saveEvBtn').onclick = async () => {
      const payload = {
        competition_id: currentCompId,
        event_code: content.querySelector('#evCode').value,
        rounds: parseInt(content.querySelector('#evRounds').value),
        format: content.querySelector('#evFormat').value,
        time_limit: content.querySelector('#evLimit').value,
        cutoff: content.querySelector('#evCutoff').value
      };
      
      if(ev) {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', ev.id), payload);
      } else {
        await addDoc(getCollRef('events'), payload);
      }
      backdrop.remove();
    };
  }

  function escapeHtml(text) {
    if (!text && text !== 0) return '';
    return text.toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

</script>
</body>
</html>
