<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WCA Asia Tracker 2025+</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --border: #30363d;
            --text: #c9d1d9; --accent: #58a6ff;
            --finished: #f85149; --open: #f2cc60; --upcoming: #2ea043;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        select { background: #0d1117; color: white; border: 1px solid var(--border); padding: 10px; border-radius: 6px; flex: 1; }
        
        .comp-card { 
            background: var(--card); border-left: 6px solid #444; 
            padding: 15px; margin-bottom: 15px; border-radius: 0 8px 8px 0;
        }
        .comp-card.finished { border-color: var(--finished); opacity: 0.8; }
        .comp-card.open { border-color: var(--open); }
        .comp-card.upcoming { border-color: var(--upcoming); }

        .comp-name { font-size: 1.25rem; font-weight: bold; color: white; text-decoration: none; }
        .main-event { font-weight: bold; text-decoration: underline; color: #fff; border-bottom: 2px solid var(--accent); }
        .reg-box { margin-top: 10px; font-size: 0.85rem; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 4px; border: 1px solid var(--border); line-height: 1.6; }
        .map-link { color: #2ea043; text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid #2ea043; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        #loader { text-align: center; color: var(--accent); padding: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div class="controls">
    <select id="countrySelect" onchange="filterList()">
        <option value="ALL">All Regions (Asia)</option>
        <option value="HK">Hong Kong</option>
        <option value="CN">China</option>
        <option value="TW">Taiwan</option>
        <option value="MO">Macau</option>
        <option value="JP">Japan</option>
        <option value="KR">South Korea</option>
        <option value="VN">Vietnam</option>
        <option value="TH">Thailand</option>
        <option value="SG">Singapore</option>
        <option value="MY">Malaysia</option>
    </select>
    <select id="eventFilter" onchange="filterList()"><option value="ALL">All Events</option></select>
</div>

<div id="loader">Loading 2025 Competitions from all regions...</div>
<div id="list"></div>

<script>
const REGIONS = ["HK", "CN", "MO", "TW", "JP", "KR", "VN", "TH", "SG", "MY"];
const EVENT_NAMES = {
    "333": "3x3x3 Cube", "222": "2x2x2 Cube", "444": "4x4x4 Cube", "555": "5x5x5 Cube",
    "333oh": "3x3x3 One-Handed", "clock": "Clock", "minx": "Megaminx", "pyram": "Pyraminx",
    "skewb": "Skewb", "sq1": "Square-1", "333bf": "3x3x3 Blindfolded", "333mbf": "3x3x3 Multi-Blind", "444bf": "4x4x4 Blindfolded", "555bf": "5x5x5 Blindfolded"
};

let MASTER_DATA = [];

async function init() {
    const loader = document.getElementById('loader');
    try {
        // Fetch all regions in parallel
        const promises = REGIONS.map(reg => 
            fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/competitions/${reg}.json`)
            .then(res => res.json())
            .catch(() => ({items: []}))
        );
        
        const results = await Promise.all(promises);
        MASTER_DATA = results.flatMap(r => r.items)
            .filter(c => new Date(c.date.from).getFullYear() >= 2025)
            .sort((a,b) => new Date(b.date.from) - new Date(a.date.from));

        updateEventFilter();
        filterList();
        loader.style.display = 'none';
    } catch (e) { loader.innerText = "Error loading initial data."; }
}

function updateEventFilter() {
    const filter = document.getElementById('eventFilter');
    const events = new Set();
    MASTER_DATA.forEach(c => c.events.forEach(e => events.add(e)));
    filter.innerHTML = '<option value="ALL">All Events</option>';
    Array.from(events).sort().forEach(e => {
        filter.innerHTML += `<option value="${e}">${EVENT_NAMES[e] || e}</option>`;
    });
}

function filterList() {
    const country = document.getElementById('countrySelect').value;
    const eventType = document.getElementById('eventFilter').value;
    
    const filtered = MASTER_DATA.filter(c => {
        const matchCountry = (country === "ALL" || c.id.includes(country) || c.country === country);
        const matchEvent = (eventType === "ALL" || c.events.includes(eventType));
        return matchCountry && matchEvent;
    });
    render(filtered);
}

function render(comps) {
    const container = document.getElementById('list');
    container.innerHTML = '';
    const now = new Date();

    comps.forEach(c => {
        const start = new Date(c.date.from);
        const end = new Date(c.date.till);
        let status = (end < now) ? 'finished' : 'upcoming';
        
        const dateStr = (c.date.from === c.date.till) 
            ? start.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})
            : `${start.toLocaleDateString('en-GB', {day:'2-digit', month:'short'})} ‚Äì ${end.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'})}`;

        const lat = c.venue.coordinates.latitude;
        const lon = c.venue.coordinates.longitude;
        const mapUrl = `https://www.google.com/maps/place${lat},${lon}`;

        const card = document.createElement('div');
        card.className = `comp-card ${status}`;
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <a href="https://worldcubeassociation.org/competitions/${c.id}" target="_blank" class="comp-name">${c.name}</a>
                <a href="${mapUrl}" target="_blank" class="map-link">üìç Map</a>
            </div>
            <div style="margin: 8px 0; font-size: 0.9rem;">üìÖ ${dateStr} | üìç ${c.city}, ${c.country}</div>
            <div id="details-${c.id}" style="font-size: 0.9rem; color: #8b949e;">Fetching v0 API data...</div>
        `;
        container.appendChild(card);
        fetchV0(c.id, card);
    });
}

async function fetchV0(compId, cardEl) {
    try {
        const proxy = "https://api.allorigins.win/get?url=";
        const v0Url = `https://www.worldcubeassociation.org/api/v0/competitions/${compId}`;
        const res = await fetch(`${proxy}${encodeURIComponent(v0Url)}`);
        const json = await res.json();
        const data = JSON.parse(json.contents);

        const now = new Date();
        const regOpen = new Date(data.registration_open);
        const regClose = new Date(data.registration_close);
        
        if (now >= regOpen && now <= regClose) cardEl.classList.replace('upcoming', 'open');

        const eventsHtml = data.event_ids.map(eid => {
            const name = EVENT_NAMES[eid] || eid;
            return (eid === data.main_event_id) ? `<span class="main-event">${name}</span>` : name;
        }).join(', ');

        const timeFormat = { 
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            timeZoneName: 'short' 
        };
        
        document.getElementById(`details-${compId}`).innerHTML = `
            <strong>Events:</strong> ${eventsHtml}
            <div class="reg-box">
                üë• <strong>Limit:</strong> ${data.competitor_limit || "N/A"} competitors<br>
                üìù <strong>Registration Period:</strong><br>
                üü¢ Opens: ${regOpen.toLocaleString('en-GB', timeFormat)}<br>
                üî¥ Closes: ${regClose.toLocaleString('en-GB', timeFormat)}
            </div>
        `;
    } catch (e) { 
        document.getElementById(`details-${compId}`).innerText = "Details (Limit/Reg) could not be loaded."; 
    }
}

init();
</script>
</body>
</html>
