import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot 
} from 'firebase/firestore';
import { 
  Calendar, 
  MapPin, 
  Users, 
  Info, 
  LogIn, 
  LogOut, 
  Plus, 
  Trash2, 
  Edit, 
  Save, 
  X, 
  Globe, 
  Mail, 
  ChevronLeft,
  LayoutGrid,
  Lock
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Default Data Structure ---
const DEFAULT_COMP_DATA = {
  id: "HongKongCubeDay2025",
  name: "Hong Kong Cube Day 2025",
  city: "Hong Kong",
  country: "HK",
  date: { from: "2025-06-07", till: "2025-06-07", numberOfDays: 1 },
  isCanceled: false,
  events: ["222", "333", "333bf", "333oh", "444"],
  wcaDelegates: [{ name: "Chan Tak Chuen (陳德泉)", email: "tchan@worldcubeassociation.org" }],
  organisers: [{ name: "Hong Kong Rubik's Cube Union", email: "info@hkrcu.net" }],
  venue: {
    name: "[The Wave](https://thewave.com.hk/)",
    address: "4 Hing Yip Street, Kwun Tong, Kowloon",
    details: "Level 8",
    coordinates: { latitude: 22.309675, longitude: 114.224519 }
  },
  information: "N/A",
  externalWebsite: "http://hkrcu.net/hkcd25"
};

// --- Helper Components ---

const TabButton = ({ active, onClick, icon: Icon, label }) => (
  <button
    onClick={onClick}
    className={`flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors border-b-2 ${
      active 
        ? 'border-blue-600 text-blue-600' 
        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
    }`}
  >
    <Icon size={16} />
    {label}
  </button>
);

const InputGroup = ({ label, children }) => (
  <div className="mb-4">
    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
      {label}
    </label>
    {children}
  </div>
);

const TextInput = ({ value, onChange, placeholder, type = "text" }) => (
  <input
    type={type}
    value={value || ''}
    onChange={(e) => onChange(e.target.value)}
    className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm"
    placeholder={placeholder}
  />
);

const TextArea = ({ value, onChange, rows = 3 }) => (
  <textarea
    value={value || ''}
    onChange={(e) => onChange(e.target.value)}
    className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm"
    rows={rows}
  />
);

// --- Main Application Component ---

export default function App() {
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false); // Simulates admin role for UI
  const [competitions, setCompetitions] = useState([]);
  const [view, setView] = useState('list'); // 'list', 'detail', 'edit'
  const [selectedComp, setSelectedComp] = useState(null);
  const [editForm, setEditForm] = useState(null);
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [loading, setLoading] = useState(true);

  // --- Auth & Data Fetching ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        // Setup Firestore Listener
        const q = collection(db, 'artifacts', appId, 'public', 'data', 'competitions');
        const unsubStore = onSnapshot(q, (snapshot) => {
          const comps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setCompetitions(comps);
          setLoading(false);
        }, (error) => {
          console.error("Firestore error:", error);
          setLoading(false);
        });
        return () => unsubStore();
      }
    });
    return () => unsubscribe();
  }, []);

  // --- Handlers ---

  const handleAdminLogin = (password) => {
    if (password === 'admin') {
      setIsAdmin(true);
      setShowLoginModal(false);
    } else {
      alert("Incorrect password. Hint: admin");
    }
  };

  const handleCreateDraft = async () => {
    if (!user || !isAdmin) return;
    try {
      const newDraft = { ...DEFAULT_COMP_DATA, createdAt: new Date().toISOString() };
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'competitions'), newDraft);
      // Optional: Auto-select newly created draft
    } catch (error) {
      console.error("Error creating draft:", error);
    }
  };

  const handleDelete = async (docId) => {
    if (!user || !isAdmin || !confirm("Are you sure you want to delete this draft?")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'competitions', docId));
      if (selectedComp?.id === docId) {
        setView('list');
        setSelectedComp(null);
      }
    } catch (error) {
      console.error("Error deleting:", error);
    }
  };

  const handleSaveEdit = async () => {
    if (!user || !isAdmin || !editForm) return;
    try {
      // Remove local ID from data before sending to Firestore
      const { id, ...dataToSave } = editForm; 
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'competitions', selectedComp.id), dataToSave);
      setSelectedComp({ ...editForm, id: selectedComp.id }); // Update local view
      setView('detail');
    } catch (error) {
      console.error("Error saving:", error);
    }
  };

  // --- Render Helpers ---

  const renderMarkdownLink = (text) => {
    if (!text) return "";
    // Simple regex for [text](url)
    const match = text.match(/\[(.*?)\]\((.*?)\)/);
    if (match) {
      return (
        <span>
          <a href={match[2]} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
            {match[1]}
          </a>
        </span>
      );
    }
    return text;
  };

  // --- Views ---

  const ListView = () => (
    <div className="p-6 max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h2 className="text-3xl font-bold text-gray-900">Competition Drafts</h2>
          <p className="text-gray-500 mt-1">Manage and view upcoming competition proposals</p>
        </div>
        {isAdmin && (
          <button 
            onClick={handleCreateDraft}
            className="flex items-center gap-2 bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium"
          >
            <Plus size={20} />
            New Draft
          </button>
        )}
      </div>

      {loading ? (
        <div className="flex justify-center py-20"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div></div>
      ) : competitions.length === 0 ? (
        <div className="text-center py-20 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
          <p className="text-gray-500">No drafts found.</p>
          {isAdmin && <button onClick={handleCreateDraft} className="mt-4 text-blue-600 font-medium hover:underline">Create one now</button>}
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {competitions.map((comp) => (
            <div 
              key={comp.id} 
              onClick={() => { setSelectedComp(comp); setView('detail'); }}
              className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all cursor-pointer group"
            >
              <div className="h-2 bg-blue-600"></div>
              <div className="p-6">
                <div className="flex justify-between items-start mb-2">
                  <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded uppercase tracking-wide">
                    {comp.id}
                  </span>
                  {comp.isCanceled && (
                    <span className="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded uppercase tracking-wide">
                      Canceled
                    </span>
                  )}
                </div>
                <h3 className="text-xl font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">
                  {comp.name}
                </h3>
                
                <div className="space-y-2 mt-4">
                  <div className="flex items-center text-sm text-gray-600">
                    <Calendar size={16} className="mr-2 text-gray-400" />
                    {comp.date?.from}
                  </div>
                  <div className="flex items-center text-sm text-gray-600">
                    <MapPin size={16} className="mr-2 text-gray-400" />
                    {comp.city}, {comp.country}
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  const DetailView = () => {
    if (!selectedComp) return null;
    const [activeTab, setActiveTab] = useState('general');

    return (
      <div className="max-w-5xl mx-auto p-6">
        <button 
          onClick={() => setView('list')} 
          className="mb-6 flex items-center text-gray-500 hover:text-gray-900 transition-colors"
        >
          <ChevronLeft size={20} className="mr-1" /> Back to List
        </button>

        <div className="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
          {/* Header */}
          <div className="bg-gray-900 text-white p-8">
            <div className="flex justify-between items-start">
              <div>
                <h1 className="text-3xl font-bold mb-2">{selectedComp.name}</h1>
                <div className="flex items-center gap-4 text-gray-300 text-sm">
                  <span className="flex items-center gap-1"><Calendar size={14} /> {selectedComp.date?.from}</span>
                  <span className="flex items-center gap-1"><MapPin size={14} /> {selectedComp.city}, {selectedComp.country}</span>
                  <span className="flex items-center gap-1"><LayoutGrid size={14} /> {selectedComp.id}</span>
                </div>
              </div>
              <div className="flex gap-2">
                {isAdmin && (
                  <>
                    <button 
                      onClick={() => { setEditForm(selectedComp); setView('edit'); }}
                      className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg backdrop-blur-sm transition-colors flex items-center gap-2 text-sm font-medium"
                    >
                      <Edit size={16} /> Edit
                    </button>
                    <button 
                      onClick={() => handleDelete(selectedComp.id)}
                      className="bg-red-500/80 hover:bg-red-600 text-white px-4 py-2 rounded-lg backdrop-blur-sm transition-colors flex items-center gap-2 text-sm font-medium"
                    >
                      <Trash2 size={16} /> Delete
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Navigation Tabs */}
          <div className="flex border-b border-gray-200 px-6 bg-gray-50/50">
            <TabButton active={activeTab === 'general'} onClick={() => setActiveTab('general')} icon={Info} label="General Info" />
            <TabButton active={activeTab === 'events'} onClick={() => setActiveTab('events')} icon={LayoutGrid} label="Events" />
            <TabButton active={activeTab === 'venue'} onClick={() => setActiveTab('venue')} icon={MapPin} label="Venue" />
            <TabButton active={activeTab === 'people'} onClick={() => setActiveTab('people')} icon={Users} label="People" />
          </div>

          {/* Content */}
          <div className="p-8 min-h-[400px]">
            {activeTab === 'general' && (
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-8">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                      <Globe size={18} className="text-blue-500" /> External Links
                    </h3>
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-500 mb-1">Official Website</p>
                      <a href={selectedComp.externalWebsite} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline break-all">
                        {selectedComp.externalWebsite}
                      </a>
                    </div>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                      <Info size={18} className="text-blue-500" /> Status
                    </h3>
                    <div className={`p-4 rounded-lg border ${selectedComp.isCanceled ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'}`}>
                      <p className="font-medium">{selectedComp.isCanceled ? 'Competition Canceled' : 'Active / Scheduled'}</p>
                    </div>
                  </div>
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 mb-3">General Information</h3>
                  <div className="bg-white p-6 border border-gray-100 rounded-xl shadow-sm text-gray-600 leading-relaxed">
                     {selectedComp.information || "No additional information provided."}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'events' && (
              <div>
                <h3 className="text-lg font-semibold text-gray-900 mb-6">Scheduled Events</h3>
                <div className="flex flex-wrap gap-3">
                  {selectedComp.events?.map((evt, idx) => (
                    <div key={idx} className="flex items-center gap-2 bg-gray-100 text-gray-800 px-4 py-3 rounded-lg font-mono font-medium border border-gray-200 shadow-sm">
                      <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                      {evt}
                    </div>
                  )) || <p className="text-gray-500 italic">No events listed.</p>}
                </div>
              </div>
            )}

            {activeTab === 'venue' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Location Details</h3>
                    <div className="space-y-4">
                      <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">Venue Name</p>
                        <p className="font-medium text-gray-900">{renderMarkdownLink(selectedComp.venue?.name)}</p>
                      </div>
                      <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">Full Address</p>
                        <p className="font-medium text-gray-900">{selectedComp.venue?.address}</p>
                      </div>
                      <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">Details / Room</p>
                        <p className="font-medium text-gray-900">{selectedComp.venue?.details}</p>
                      </div>
                    </div>
                 </div>
                 <div>
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Coordinates</h3>
                    <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 flex flex-col justify-center items-center text-center h-48">
                      <MapPin size={32} className="text-blue-500 mb-2" />
                      <p className="text-2xl font-mono font-bold text-blue-900 mb-1">
                        {selectedComp.venue?.coordinates?.latitude.toFixed(4)}, {selectedComp.venue?.coordinates?.longitude.toFixed(4)}
                      </p>
                      <a 
                        href={`https://www.google.com/maps/search/?api=1&query=${selectedComp.venue?.coordinates?.latitude},${selectedComp.venue?.coordinates?.longitude}`}
                        target="_blank"
                        rel="noreferrer"
                        className="text-sm text-blue-600 hover:underline mt-2"
                      >
                        View on Google Maps
                      </a>
                    </div>
                 </div>
              </div>
            )}

            {activeTab === 'people' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Users size={18} className="text-blue-500" /> Organisers
                  </h3>
                  <div className="space-y-3">
                    {selectedComp.organisers?.map((org, i) => (
                      <div key={i} className="flex items-start gap-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div className="bg-blue-100 p-2 rounded-full text-blue-600">
                          <Users size={16} />
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">{org.name}</p>
                          <a href={`mailto:${org.email}`} className="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mt-1">
                            <Mail size={12} /> {org.email}
                          </a>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Users size={18} className="text-red-500" /> WCA Delegates
                  </h3>
                  <div className="space-y-3">
                    {selectedComp.wcaDelegates?.map((del, i) => (
                      <div key={i} className="flex items-start gap-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div className="bg-red-100 p-2 rounded-full text-red-600">
                          <Users size={16} />
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">{del.name}</p>
                          <a href={`mailto:${del.email}`} className="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1 mt-1">
                            <Mail size={12} /> {del.email}
                          </a>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const EditView = () => {
    if (!editForm) return null;
    const [activeTab, setActiveTab] = useState('general');

    const updateField = (path, value) => {
      setEditForm(prev => {
        const newData = { ...prev };
        // Simple deep set for specific known paths
        if (path.includes('.')) {
          const [parent, child] = path.split('.');
          if (parent === 'venue' && child === 'coordinates') {
            // handle deeply nested coordinates separately if needed, but here value is object
          } else {
             newData[parent] = { ...newData[parent], [child]: value };
          }
        } else {
          newData[path] = value;
        }
        return newData;
      });
    };

    const updateArrayItem = (arrayName, index, field, value) => {
        setEditForm(prev => {
            const newArray = [...prev[arrayName]];
            newArray[index] = { ...newArray[index], [field]: value };
            return { ...prev, [arrayName]: newArray };
        });
    };

    const removeArrayItem = (arrayName, index) => {
        setEditForm(prev => {
            const newArray = prev[arrayName].filter((_, i) => i !== index);
            return { ...prev, [arrayName]: newArray };
        });
    };

    const addArrayItem = (arrayName, emptyItem) => {
        setEditForm(prev => ({
            ...prev,
            [arrayName]: [...(prev[arrayName] || []), emptyItem]
        }));
    };

    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-900">Edit Competition</h2>
          <div className="flex gap-3">
            <button onClick={() => setView('detail')} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
            <button onClick={handleSaveEdit} className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
              <Save size={18} /> Save Changes
            </button>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
           <div className="flex border-b border-gray-200 px-6 bg-gray-50/50">
            <TabButton active={activeTab === 'general'} onClick={() => setActiveTab('general')} icon={Info} label="General" />
            <TabButton active={activeTab === 'events'} onClick={() => setActiveTab('events')} icon={LayoutGrid} label="Events" />
            <TabButton active={activeTab === 'venue'} onClick={() => setActiveTab('venue')} icon={MapPin} label="Venue" />
            <TabButton active={activeTab === 'people'} onClick={() => setActiveTab('people')} icon={Users} label="People" />
          </div>

          <div className="p-8">
             {activeTab === 'general' && (
               <div className="space-y-4">
                 <div className="grid grid-cols-2 gap-4">
                    <InputGroup label="ID">
                        <TextInput value={editForm.id} onChange={(v) => updateField('id', v)} />
                    </InputGroup>
                    <InputGroup label="Competition Name">
                        <TextInput value={editForm.name} onChange={(v) => updateField('name', v)} />
                    </InputGroup>
                 </div>
                 <div className="grid grid-cols-2 gap-4">
                    <InputGroup label="City">
                        <TextInput value={editForm.city} onChange={(v) => updateField('city', v)} />
                    </InputGroup>
                    <InputGroup label="Country">
                        <TextInput value={editForm.country} onChange={(v) => updateField('country', v)} />
                    </InputGroup>
                 </div>
                 <div className="grid grid-cols-3 gap-4">
                     <InputGroup label="From Date">
                         <TextInput type="date" value={editForm.date.from} onChange={(v) => updateField('date', { ...editForm.date, from: v })} />
                     </InputGroup>
                     <InputGroup label="Till Date">
                         <TextInput type="date" value={editForm.date.till} onChange={(v) => updateField('date', { ...editForm.date, till: v })} />
                     </InputGroup>
                     <InputGroup label="Days">
                         <TextInput type="number" value={editForm.date.numberOfDays} onChange={(v) => updateField('date', { ...editForm.date, numberOfDays: parseInt(v) })} />
                     </InputGroup>
                 </div>
                 <InputGroup label="External Website">
                     <TextInput value={editForm.externalWebsite} onChange={(v) => updateField('externalWebsite', v)} />
                 </InputGroup>
                 <InputGroup label="Information">
                     <TextArea value={editForm.information} onChange={(v) => updateField('information', v)} rows={5} />
                 </InputGroup>
                 <div className="flex items-center gap-2 mt-4">
                    <input 
                        type="checkbox" 
                        id="canceled"
                        checked={editForm.isCanceled} 
                        onChange={(e) => updateField('isCanceled', e.target.checked)} 
                        className="w-4 h-4 text-blue-600 rounded"
                    />
                    <label htmlFor="canceled" className="text-sm font-medium text-gray-700">Mark as Canceled</label>
                 </div>
               </div>
             )}

             {activeTab === 'events' && (
               <div>
                 <InputGroup label="Events (Comma separated codes, e.g., 333, 444, 333oh)">
                   <TextInput 
                     value={editForm.events.join(', ')} 
                     onChange={(v) => updateField('events', v.split(',').map(s => s.trim()).filter(Boolean))} 
                   />
                 </InputGroup>
                 <div className="mt-4 flex flex-wrap gap-2">
                    {editForm.events.map((e, i) => (
                        <span key={i} className="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-600 border border-gray-200">{e}</span>
                    ))}
                 </div>
               </div>
             )}

             {activeTab === 'venue' && (
                <div className="space-y-4">
                    <InputGroup label="Venue Name (Markdown supported)">
                        <TextInput value={editForm.venue.name} onChange={(v) => updateField('venue.name', v)} />
                    </InputGroup>
                    <InputGroup label="Address">
                        <TextInput value={editForm.venue.address} onChange={(v) => updateField('venue.address', v)} />
                    </InputGroup>
                    <InputGroup label="Details (e.g., Floor, Room)">
                        <TextInput value={editForm.venue.details} onChange={(v) => updateField('venue.details', v)} />
                    </InputGroup>
                    <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                        <InputGroup label="Latitude">
                            <TextInput 
                                type="number" 
                                value={editForm.venue.coordinates.latitude} 
                                onChange={(v) => updateField('venue', { ...editForm.venue, coordinates: { ...editForm.venue.coordinates, latitude: parseFloat(v) } })} 
                            />
                        </InputGroup>
                        <InputGroup label="Longitude">
                            <TextInput 
                                type="number" 
                                value={editForm.venue.coordinates.longitude} 
                                onChange={(v) => updateField('venue', { ...editForm.venue, coordinates: { ...editForm.venue.coordinates, longitude: parseFloat(v) } })} 
                            />
                        </InputGroup>
                    </div>
                </div>
             )}

             {activeTab === 'people' && (
               <div className="space-y-8">
                  <div>
                      <div className="flex justify-between items-center mb-4">
                        <h4 className="font-semibold text-gray-900">Organisers</h4>
                        <button onClick={() => addArrayItem('organisers', {name: '', email: ''})} className="text-xs text-blue-600 font-bold hover:underline">+ Add Organiser</button>
                      </div>
                      <div className="space-y-3">
                          {editForm.organisers.map((org, idx) => (
                              <div key={idx} className="flex gap-2 items-start">
                                  <div className="flex-1 space-y-2">
                                    <TextInput value={org.name} onChange={(v) => updateArrayItem('organisers', idx, 'name', v)} placeholder="Name" />
                                    <TextInput value={org.email} onChange={(v) => updateArrayItem('organisers', idx, 'email', v)} placeholder="Email" />
                                  </div>
                                  <button onClick={() => removeArrayItem('organisers', idx)} className="p-2 text-red-400 hover:text-red-600"><X size={16} /></button>
                              </div>
                          ))}
                      </div>
                  </div>
                  <div className="border-t pt-6">
                      <div className="flex justify-between items-center mb-4">
                        <h4 className="font-semibold text-gray-900">WCA Delegates</h4>
                        <button onClick={() => addArrayItem('wcaDelegates', {name: '', email: ''})} className="text-xs text-blue-600 font-bold hover:underline">+ Add Delegate</button>
                      </div>
                      <div className="space-y-3">
                          {editForm.wcaDelegates.map((del, idx) => (
                              <div key={idx} className="flex gap-2 items-start">
                                  <div className="flex-1 space-y-2">
                                    <TextInput value={del.name} onChange={(v) => updateArrayItem('wcaDelegates', idx, 'name', v)} placeholder="Name" />
                                    <TextInput value={del.email} onChange={(v) => updateArrayItem('wcaDelegates', idx, 'email', v)} placeholder="Email" />
                                  </div>
                                  <button onClick={() => removeArrayItem('wcaDelegates', idx)} className="p-2 text-red-400 hover:text-red-600"><X size={16} /></button>
                              </div>
                          ))}
                      </div>
                  </div>
               </div>
             )}
          </div>
        </div>
      </div>
    );
  };

  const LoginModal = () => {
    const [pwd, setPwd] = useState('');
    if (!showLoginModal) return null;
    return (
      <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-gray-900">Admin Login</h3>
            <button onClick={() => setShowLoginModal(false)}><X size={20} className="text-gray-400 hover:text-gray-600" /></button>
          </div>
          <p className="text-sm text-gray-500 mb-4">Enter password to manage competitions.</p>
          <input 
            type="password" 
            className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none"
            placeholder="Password"
            value={pwd}
            onChange={(e) => setPwd(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleAdminLogin(pwd)}
          />
          <button 
            onClick={() => handleAdminLogin(pwd)}
            className="w-full bg-gray-900 text-white font-medium py-3 rounded-lg hover:bg-black transition-colors"
          >
            Access Dashboard
          </button>
          <p className="text-xs text-center text-gray-400 mt-4">Hint: admin</p>
        </div>
      </div>
    );
  };

  // --- Main Layout ---

  return (
    <div className="min-h-screen bg-[#f8f9fa] font-sans text-gray-900">
      {/* Navbar */}
      <nav className="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('list')}>
             <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">C</div>
             <span className="font-bold text-xl tracking-tight">CompManager</span>
          </div>
          <div>
            {isAdmin ? (
               <div className="flex items-center gap-4">
                 <span className="text-sm font-medium text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-100 flex items-center gap-1">
                    <Lock size={12} /> Admin Mode
                 </span>
                 <button 
                   onClick={() => setIsAdmin(false)}
                   className="text-gray-500 hover:text-gray-900 transition-colors flex items-center gap-2 text-sm font-medium"
                 >
                   <LogOut size={16} /> Logout
                 </button>
               </div>
            ) : (
              <button 
                onClick={() => setShowLoginModal(true)}
                className="text-gray-600 hover:text-blue-600 transition-colors flex items-center gap-2 text-sm font-medium"
              >
                <LogIn size={16} /> Admin Login
              </button>
            )}
          </div>
        </div>
      </nav>

      <main className="py-8">
        {view === 'list' && <ListView />}
        {view === 'detail' && <DetailView />}
        {view === 'edit' && <EditView />}
      </main>

      <LoginModal />
    </div>
  );
}
