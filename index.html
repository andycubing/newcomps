<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HK Cube Drafts</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --muted:#9aa7bf; --accent:#60a5fa; --text:#e6eef8;
      --light-bg:#f6f8fb; --light-card:#ffffff; --light-text:#0b1220; --light-muted:#475569;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);color:var(--text);padding:18px;box-sizing:border-box;}
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .top-actions{display:flex;gap:8px;align-items:center}
    button{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text);padding:8px 10px;border-radius:6px;cursor:pointer}
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .list-row{cursor:pointer}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .tab.active{background:var(--accent);color:#04233a}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .full{grid-column:1/-1}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .danger{border-color:#ff6b6b;color:#ffb4b4}
    .hidden{display:none}
    .flex{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:6px}
    .dark-toggle{display:flex;align-items:center;gap:6px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .top-actions{flex-wrap:wrap} }
    /* Light mode */
    .light body{background:var(--light-bg);color:var(--light-text)}
    .light .card{background:var(--light-card);box-shadow:0 1px 4px rgba(2,6,23,0.04)}
    .light input, .light select, .light textarea{background:transparent;color:var(--light-text);border:1px solid rgba(2,6,23,0.06)}
    .light button{border:1px solid rgba(2,6,23,0.06);color:var(--light-text)}
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div>
        <h1>HK Cube Drafts</h1>
        <div class="muted small">Draft competition manager — Hong Kong</div>
      </div>

      <div class="top-actions">
        <div class="dark-toggle">
          <label class="small muted">Dark</label>
          <input id="darkToggle" type="checkbox" />
        </div>
        <div id="authArea" class="flex">
          <input id="email" placeholder="admin email" style="width:200px" />
          <input id="password" type="password" placeholder="password" style="width:160px" />
          <button id="signinBtn">Sign in</button>
          <button id="signoutBtn" class="hidden">Sign out</button>
        </div>
      </div>
    </header>

    <main>
      <div id="mainContent" class="grid">
        <!-- Left: list & details -->
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>Drafted Competitions</strong>
                <div class="muted small">Click a row to open a draft</div>
              </div>
              <div>
                <button id="newCompBtn">+ New Draft</button>
              </div>
            </div>

            <div id="listArea" style="margin-top:12px">
              <table id="compsTable">
                <thead><tr><th>Name</th><th>Start</th><th>End</th><th>Venue</th></tr></thead>
                <tbody id="compsTbody"></tbody>
              </table>
            </div>
          </div>

          <div id="compCard" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h2 id="compName" style="margin:0"></h2>
                <div id="compMeta" class="muted small"></div>
              </div>
              <div id="adminActions" class="flex hidden">
                <button id="editCompBtn">Edit</button>
                <button id="deleteCompBtn" class="danger">Delete</button>
                <button id="cloneCompBtn">Clone</button>
              </div>
            </div>

            <div class="tabs" id="tabs"></div>

            <div id="tabContent" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- Right: quick info / admin settings -->
        <div>
          <div class="card">
            <strong>Account</strong>
            <div id="userInfo" class="muted small">Not signed in</div>
            <div id="adminBadge" class="muted small hidden">You are an admin</div>
            <div style="margin-top:8px">
              <button id="changePassBtn" class="hidden">Change password</button>
            </div>
          </div>

          <div class="card">
            <strong>Help</strong>
            <div class="muted small">This static page uses Supabase for storage. Replace the placeholders in the script with your Supabase URL and anon key. Configure RLS so only admins can edit protected tables.</div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/* =========================
   CONFIG: Replace these
   ========================= */
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'; // <-- replace
const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';               // <-- replace
/* ========================= */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* UI elements */
const compsTbody = document.getElementById('compsTbody');
const compCard = document.getElementById('compCard');
const compNameEl = document.getElementById('compName');
const compMetaEl = document.getElementById('compMeta');
const tabsEl = document.getElementById('tabs');
const tabContent = document.getElementById('tabContent');
const adminActions = document.getElementById('adminActions');
const userInfo = document.getElementById('userInfo');
const adminBadge = document.getElementById('adminBadge');
const changePassBtn = document.getElementById('changePassBtn');

let currentComp = null;
let currentUser = null;
let isAdmin = false;
let autosaveTimer = null;

/* Event definitions and validation rules */
const EVENTS = ['3x3','2x2','4x4','5x5','6x6','7x7','3BLD','FMC','3x3 OH','Clock','Megaminx','Pyraminx','Skewb','Square-1','4BLD','5BLD','MBLD'];

function allowedFormatsForEvent(eventCode) {
  // returns array of allowed formats
  if (eventCode === '3BLD') return ['Best of 5','Best of 3','Best of 1','Best of 2'];
  if (eventCode === '6x6' || eventCode === '7x7') return ['Mean of 3'];
  if (eventCode === '4BLD' || eventCode === '5BLD') return ['Best of 3'];
  if (eventCode === 'MBLD') return ['Best of 1','Best of 2'];
  if (eventCode === 'FMC') return ['Best of 1','Best of 2','Mean of 3'];
  // default
  return ['Average of 5'];
}

/* -------------------------
   Auth & UI wiring
   ------------------------- */
document.getElementById('signinBtn').addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if (!email || !password) return alert('Enter email and password');
  const { error, data } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);
  await refreshSession();
});

document.getElementById('signoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  await refreshSession();
});

document.getElementById('newCompBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('Only admins can create drafts');
  const name = prompt('New draft name');
  if (!name) return;
  const { data, error } = await supabase.from('competitions').insert([{ name }]).select().single();
  if (error) return alert(error.message);
  await logAudit('insert','competitions', data.id, { name });
  loadCompetitions();
  openCompetition(data.id);
});

document.getElementById('editCompBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  openEditor();
});

document.getElementById('deleteCompBtn').addEventListener('click', async () => {
  if (!isAdmin) return;
  if (!confirm('Delete this draft?')) return;
  const { error } = await supabase.from('competitions').delete().eq('id', currentComp.id);
  if (error) return alert(error.message);
  await logAudit('delete','competitions', currentComp.id, { name: currentComp.name });
  currentComp = null;
  compCard.classList.add('hidden');
  loadCompetitions();
});

document.getElementById('cloneCompBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('Only admins can clone');
  const clone = Object.assign({}, currentComp);
  delete clone.id; clone.name = clone.name + ' (clone)';
  const { data, error } = await supabase.from('competitions').insert([clone]).select().single();
  if (error) return alert(error.message);
  await logAudit('insert','competitions', data.id, { cloned_from: currentComp.id });
  loadCompetitions();
});

/* change password */
changePassBtn.addEventListener('click', async () => {
  const newPass = prompt('Enter new password (min 6 chars)');
  if (!newPass || newPass.length < 6) return alert('Password too short');
  const { error } = await supabase.auth.updateUser({ password: newPass });
  if (error) return alert(error.message);
  alert('Password updated');
});

/* dark mode toggle */
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('change', () => {
  if (darkToggle.checked) document.documentElement.classList.remove('light');
  else document.documentElement.classList.add('light');
});
/* default: dark on */
darkToggle.checked = true;

/* session refresh & admin check */
async function refreshSession() {
  const { data } = await supabase.auth.getSession();
  const session = data.session;
  if (!session) {
    currentUser = null; isAdmin = false;
    userInfo.textContent = 'Not signed in';
    adminBadge.classList.add('hidden');
    document.getElementById('signinBtn').classList.remove('hidden');
    document.getElementById('signoutBtn').classList.add('hidden');
    changePassBtn.classList.add('hidden');
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    return;
  }
  const { data: userData } = await supabase.auth.getUser();
  currentUser = userData.user;
  userInfo.textContent = currentUser.email;
  document.getElementById('signinBtn').classList.add('hidden');
  document.getElementById('signoutBtn').classList.remove('hidden');
  // check admin role in raw_user_meta_data
  const role = currentUser?.raw_user_meta_data?.role;
  isAdmin = role === 'admin';
  if (isAdmin) {
    adminBadge.classList.remove('hidden');
    changePassBtn.classList.remove('hidden');
  } else {
    adminBadge.classList.add('hidden');
    changePassBtn.classList.add('hidden');
  }
  // show admin actions if a comp is open
  if (currentComp) adminActions.classList.toggle('hidden', !isAdmin);
}

/* subscribe to auth changes */
supabase.auth.onAuthStateChange((_event, session) => {
  refreshSession();
});

/* -------------------------
   Load competitions list
   ------------------------- */
async function loadCompetitions() {
  const { data, error } = await supabase.from('competitions').select('*').order('start_date', { ascending: true });
  if (error) { console.error(error); return; }
  compsTbody.innerHTML = '';
  data.forEach(c => {
    const tr = document.createElement('tr');
    tr.className = 'list-row';
    tr.innerHTML = `<td>${escapeHtml(c.name||'Untitled')}</td><td>${c.start_date||''}</td><td>${c.end_date||''}</td><td>${escapeHtml(c.venue||'')}</td>`;
    tr.addEventListener('click', () => openCompetition(c.id));
    compsTbody.appendChild(tr);
  });
}

/* open competition details */
async function openCompetition(id) {
  const { data, error } = await supabase.from('competitions').select('*').eq('id', id).single();
  if (error) { alert(error.message); return; }
  currentComp = data;
  compCard.classList.remove('hidden');
  compNameEl.textContent = currentComp.name || 'Untitled';
  compMetaEl.textContent = `${currentComp.start_date || ''} — ${currentComp.end_date || ''} · ${currentComp.venue || ''}`;
  adminActions.classList.toggle('hidden', !isAdmin);
  renderTabs();
  renderTabContent('Home');
  await refreshSession();
}

/* render tabs */
const TAB_LIST = ['Home','Event','Schedule','Draft Budget','Actual Budget','Checklist','Staff','Travel','Prize','Remarks'];
function renderTabs() {
  tabsEl.innerHTML = '';
  TAB_LIST.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (t==='Home' ? ' active' : '');
    btn.textContent = t;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      renderTabContent(t);
    });
    // hide Actual Budget tab for non-admins
    if (t === 'Actual Budget' && !isAdmin) btn.classList.add('hidden');
    tabsEl.appendChild(btn);
  });
}

/* render content for a tab */
async function renderTabContent(tab) {
  tabContent.innerHTML = '';
  if (!currentComp) return;
  if (tab === 'Home') {
    const html = `
      <div class="grid full">
        <div class="col">
          <label class="small muted">Name</label>
          <input id="nameInput" value="${escapeHtml(currentComp.name||'')}" />
          <label class="small muted">Start date</label>
          <input id="startInput" type="date" value="${currentComp.start_date||''}" />
          <label class="small muted">End date</label>
          <input id="endInput" type="date" value="${currentComp.end_date||''}" />
          <label class="small muted">Venue</label>
          <input id="venueInput" value="${escapeHtml(currentComp.venue||'')}" />
          <label class="small muted">Address</label>
          <input id="addressInput" value="${escapeHtml(currentComp.address||'')}" />
          <label class="small muted">Competitor limit</label>
          <input id="limitInput" type="number" value="${currentComp.competitor_limit||''}" />
          <label class="small muted">Base registration fee</label>
          <input id="baseFeeInput" type="number" step="0.01" value="${currentComp.base_fee||''}" />
          <label class="small muted">Registration open (datetime)</label>
          <input id="regOpenInput" type="datetime-local" value="${formatDatetimeLocal(currentComp.reg_open)}" />
          <div style="margin-top:8px">
            ${isAdmin ? '<button id="saveHomeBtn">Save</button>' : ''}
            <button id="viewAsBtn">View as viewer</button>
          </div>
        </div>
      </div>
    `;
    tabContent.innerHTML = html;
    if (isAdmin) document.getElementById('saveHomeBtn').addEventListener('click', saveHome);
    document.getElementById('viewAsBtn').addEventListener('click', () => alert('Viewing as normal viewer — admin-only controls are hidden.'));
  }

  if (tab === 'Event') {
    await renderEventTab();
  }

  if (tab === 'Schedule') {
    await renderScheduleTab();
  }

  if (tab === 'Draft Budget') {
    await renderDraftBudgetTab();
  }

  if (tab === 'Actual Budget') {
    await renderActualBudgetTab();
  }

  if (tab === 'Checklist') {
    await renderChecklistTab();
  }

  if (tab === 'Staff') {
    await renderStaffTab();
  }

  if (tab === 'Travel' || tab === 'Prize' || tab === 'Remarks') {
    await renderFreeTab(tab);
  }
}

/* -------------------------
   Home save
   ------------------------- */
async function saveHome() {
  if (!isAdmin) return alert('Only admins can save');
  const payload = {
    name: document.getElementById('nameInput').value.trim(),
    start_date: document.getElementById('startInput').value || null,
    end_date: document.getElementById('endInput').value || null,
    venue: document.getElementById('venueInput').value.trim(),
    address: document.getElementById('addressInput').value.trim(),
    competitor_limit: parseInt(document.getElementById('limitInput').value) || null,
    base_fee: parseFloat(document.getElementById('baseFeeInput').value) || null,
    reg_open: document.getElementById('regOpenInput').value ? new Date(document.getElementById('regOpenInput').value).toISOString() : null
  };
  const { error } = await supabase.from('competitions').update(payload).eq('id', currentComp.id);
  if (error) return alert(error.message);
  await logAudit('update','competitions', currentComp.id, payload);
  // refresh
  await openCompetition(currentComp.id);
  alert('Saved');
}

/* -------------------------
   Event tab
   ------------------------- */
async function renderEventTab() {
  // fetch events for this competition
  const { data: events } = await supabase.from('events').select('*').eq('competition_id', currentComp.id).order('created_at', { ascending: true });
  const container = document.createElement('div');
  container.className = 'col';
  const addBtn = document.createElement('button');
  addBtn.textContent = 'Add Event';
  addBtn.addEventListener('click', () => openEventEditor());
  container.appendChild(addBtn);

  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Event</th><th>Rounds</th><th>Format</th><th>Time limit</th><th>Cutoff</th><th>Advancement</th><th>Actions</th></tr></thead>`;
  const tbody = document.createElement('tbody');

  (events || []).forEach(ev => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(ev.event_code)}</td><td>${ev.rounds}</td><td>${escapeHtml(ev.format||'')}</td><td>${escapeHtml(ev.time_limit||'')}</td><td>${escapeHtml(ev.cutoff||'')}</td><td>${escapeHtml(JSON.stringify(ev.advancement||{}))}</td>
      <td>
        ${isAdmin ? `<button class="editEv">Edit</button><button class="delEv danger">Delete</button>` : ''}
      </td>`;
    if (isAdmin) {
      tr.querySelector('.editEv').addEventListener('click', () => openEventEditor(ev));
      tr.querySelector('.delEv').addEventListener('click', async () => {
        if (!confirm('Delete event?')) return;
        const { error } = await supabase.from('events').delete().eq('id', ev.id);
        if (error) return alert(error.message);
        await logAudit('delete','events', ev.id, { event_code: ev.event_code });
        renderTabContent('Event');
      });
    }
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  container.appendChild(table);
  tabContent.appendChild(container);
}

/* event editor modal (simple prompt-based) */
function openEventEditor(ev = null) {
  if (!isAdmin) return alert('Only admins can edit events');
  // build a small form in prompt-like modal
  const modal = document.createElement('div');
  modal.className = 'card';
  modal.style.position = 'fixed';
  modal.style.left = '50%';
  modal.style.top = '50%';
  modal.style.transform = 'translate(-50%,-50%)';
  modal.style.zIndex = 9999;
  modal.style.width = '720px';
  modal.innerHTML = `
    <h3>${ev ? 'Edit' : 'Add'} Event</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
      <div>
        <label class="small muted">Event</label>
        <select id="ev_code">${EVENTS.map(e => `<option value="${e}" ${ev && ev.event_code===e ? 'selected' : ''}>${e}</option>`).join('')}</select>
        <label class="small muted">Rounds (1-4)</label>
        <input id="ev_rounds" type="number" min="1" max="4" value="${ev ? ev.rounds : 1}" />
        <label class="small muted">Format</label>
        <select id="ev_format"></select>
        <label class="small muted">Time limit (HH:MM:SS or MM:SS)</label>
        <input id="ev_time" value="${ev ? ev.time_limit : ''}" />
        <label class="small muted">Cutoff (leave blank if none)</label>
        <input id="ev_cutoff" value="${ev ? ev.cutoff : ''}" />
      </div>
      <div>
        <label class="small muted">Advancement (JSON or leave blank)</label>
        <textarea id="ev_adv" rows="8">${ev ? JSON.stringify(ev.advancement||{}, null, 2) : ''}</textarea>
        <label class="small muted">Qualification message</label>
        <input id="ev_qual" value="${ev ? escapeHtml(ev.qualification||'') : ''}" />
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="saveEvBtn">Save</button>
      <button id="cancelEvBtn">Cancel</button>
    </div>
  `;
  document.body.appendChild(modal);

  const evCode = modal.querySelector('#ev_code');
  const evFormat = modal.querySelector('#ev_format');
  function populateFormats() {
    const allowed = allowedFormatsForEvent(evCode.value);
    evFormat.innerHTML = allowed.map(f => `<option value="${f}" ${ev && ev.format===f ? 'selected' : ''}>${f}</option>`).join('');
  }
  evCode.addEventListener('change', populateFormats);
  populateFormats();

  modal.querySelector('#cancelEvBtn').addEventListener('click', () => modal.remove());
  modal.querySelector('#saveEvBtn').addEventListener('click', async () => {
    const payload = {
      competition_id: currentComp.id,
      event_code: evCode.value,
      rounds: parseInt(modal.querySelector('#ev_rounds').value) || 1,
      format: evFormat.value,
      time_limit: modal.querySelector('#ev_time').value.trim(),
      cutoff: modal.querySelector('#ev_cutoff').value.trim(),
      advancement: parseJsonSafe(modal.querySelector('#ev_adv').value),
      qualification: modal.querySelector('#ev_qual').value.trim()
    };
    // validation: rounds <=4
    if (payload.rounds < 1 || payload.rounds > 4) return alert('Rounds must be 1-4');
    // validate time format (simple)
    if (payload.time_limit && !/^\d{1,2}:\d{2}(:\d{2})?$/.test(payload.time_limit)) return alert('Time limit format invalid');
    // format validation: ensure allowed
    const allowed = allowedFormatsForEvent(payload.event_code);
    if (!allowed.includes(payload.format)) return alert('Selected format not allowed for this event');
    if (ev) {
      const { error } = await supabase.from('events').update(payload).eq('id', ev.id);
      if (error) return alert(error.message);
      await logAudit('update','events', ev.id, payload);
    } else {
      const { data, error } = await supabase.from('events').insert([payload]).select().single();
      if (error) return alert(error.message);
      await logAudit('insert','events', data.id, payload);
    }
    modal.remove();
    renderTabContent('Event');
  });
}

/* -------------------------
   Schedule tab
   ------------------------- */
async function renderScheduleTab() {
  const { data: schedules } = await supabase.from('schedules').select('*').eq('competition_id', currentComp.id).order('day', { ascending: true }).order('start_time', { ascending: true });
  const container = document.createElement('div');
  container.className = 'col';
  const addBtn = document.createElement('button');
  addBtn.textContent = 'Add Schedule Row';
  addBtn.addEventListener('click', async () => {
    if (!isAdmin) return alert('Only admins can add schedule');
    const day = parseInt(prompt('Day number (1,2,...)', '1')) || 1;
    const start = prompt('Start time (YYYY-MM-DDTHH:MM)', '');
    const end = prompt('End time (YYYY-MM-DDTHH:MM)', '');
    const rundown = prompt('Rundown text', '');
    const duration = prompt('Duration (e.g., 01:30:00)', '');
    const payload = { competition_id: currentComp.id, day, start_time: start ? new Date(start).toISOString() : null, end_time: end ? new Date(end).toISOString() : null, rundown, duration: duration ? duration : null };
    const { data, error } = await supabase.from('schedules').insert([payload]).select().single();
    if (error) return alert(error.message);
    await logAudit('insert','schedules', data.id, payload);
    renderTabContent('Schedule');
  });
  container.appendChild(addBtn);

  const days = groupBy(schedules || [], s => s.day || 1);
  for (const day of Object.keys(days).sort((a,b)=>a-b)) {
    const dayCard = document.createElement('div');
    dayCard.className = 'card';
    dayCard.innerHTML = `<strong>Day ${day}</strong>`;
    const t = document.createElement('table');
    t.innerHTML = `<thead><tr><th>Start</th><th>End</th><th>Rundown</th><th>Duration</th><th>Actions</th></tr></thead>`;
    const tb = document.createElement('tbody');
    days[day].forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.start_time ? new Date(row.start_time).toLocaleString() : ''}</td><td>${row.end_time ? new Date(row.end_time).toLocaleString() : ''}</td><td>${escapeHtml(row.rundown||'')}</td><td>${row.duration||''}</td>
        <td>${isAdmin ? '<button class="delSch danger">Delete</button>' : ''}</td>`;
      if (isAdmin) tr.querySelector('.delSch').addEventListener('click', async () => {
        if (!confirm('Delete schedule row?')) return;
        const { error } = await supabase.from('schedules').delete().eq('id', row.id);
        if (error) return alert(error.message);
        await logAudit('delete','schedules', row.id, { day: row.day });
        renderTabContent('Schedule');
      });
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    dayCard.appendChild(t);
    container.appendChild(dayCard);
  }

  tabContent.appendChild(container);
}

/* -------------------------
   Draft Budget tab (with gate)
   ------------------------- */
async function renderDraftBudgetTab() {
  // gate: require extra password to view/edit
  const container = document.createElement('div');
  container.className = 'col';
  const gateDiv = document.createElement('div');
  gateDiv.innerHTML = `
    <div class="muted small">Draft Budget is protected. Enter extra password to view/edit.</div>
    <input id="gatePass" type="password" placeholder="Draft budget password" style="width:220px" />
    <button id="gateBtn">Unlock</button>
    <div id="gateMsg" class="muted small"></div>
  `;
  container.appendChild(gateDiv);
  tabContent.appendChild(container);

  document.getElementById('gateBtn').addEventListener('click', async () => {
    const p = document.getElementById('gatePass').value;
    if (!p) return alert('Enter password');
    // call RPC check_gate(p_name text, p_password text) -> boolean
    const { data, error } = await supabase.rpc('check_gate', { p_name: 'draft_budget', p_password: p });
    if (error) return alert(error.message);
    if (!data) return document.getElementById('gateMsg').textContent = 'Password incorrect';
    document.getElementById('gateMsg').textContent = 'Unlocked';
    // show budget editor
    await showDraftBudgetEditor(container);
  });
}

async function showDraftBudgetEditor(container) {
  // fetch budgets of kind 'draft'
  const { data: budgets } = await supabase.from('budgets').select('*').eq('competition_id', currentComp.id).eq('kind','draft').order('created_at', { ascending: true });
  container.innerHTML = '';
  const addRowBtn = document.createElement('button');
  addRowBtn.textContent = 'Add Budget Row';
  addRowBtn.addEventListener('click', async () => {
    if (!isAdmin) return alert('Only admins can add');
    const itemType = prompt('Item type (income/expense)', 'income');
    const description = prompt('Description', '');
    const event = prompt('Event (optional)', '');
    const estimated_count = parseInt(prompt('Estimated number (optional)', '0')) || 0;
    const amount = parseFloat(prompt('Amount', '0')) || 0;
    const payload = { competition_id: currentComp.id, kind: 'draft', item_type: itemType, description, event, estimated_count, amount };
    const { data, error } = await supabase.from('budgets').insert([payload]).select().single();
    if (error) return alert(error.message);
    await logAudit('insert','budgets', data.id, payload);
    renderTabContent('Draft Budget');
  });
  container.appendChild(addRowBtn);

  // registration fee table (first part)
  const feeCard = document.createElement('div');
  feeCard.className = 'card';
  feeCard.innerHTML = `<strong>Registration fee table</strong><div class="muted small">Event | Estimated competitors | Additional fee</div>`;
  const feeTable = document.createElement('table');
  feeTable.innerHTML = `<thead><tr><th>Event</th><th>Estimated</th><th>Additional fee</th></tr></thead>`;
  const feeTb = document.createElement('tbody');
  // show budgets that are income and event not empty
  (budgets || []).filter(b => b.item_type === 'income' && b.event).forEach(b => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(b.event)}</td><td>${b.estimated_count||0}</td><td>${b.amount||0}</td>`;
    feeTb.appendChild(tr);
  });
  feeTable.appendChild(feeTb);
  feeCard.appendChild(feeTable);
  container.appendChild(feeCard);

  // profit & loss table
  const pnlCard = document.createElement('div');
  pnlCard.className = 'card';
  pnlCard.innerHTML = `<strong>Profit & Loss</strong><div class="muted small">Left: Income | Right: Expenses (default: Venue Renting, WCA Dues = 15% of total minimum registration fee)</div>`;
  const pnlTable = document.createElement('table');
  pnlTable.innerHTML = `<thead><tr><th>Type</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead>`;
  const pnlTb = document.createElement('tbody');
  (budgets || []).forEach(b => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(b.item_type)}</td><td>${escapeHtml(b.description||b.event||'')}</td><td>${b.amount||0}</td><td>${isAdmin ? '<button class="delBud danger">Delete</button>' : ''}</td>`;
    if (isAdmin && tr.querySelector('.delBud')) {
      tr.querySelector('.delBud').addEventListener('click', async () => {
        if (!confirm('Delete budget row?')) return;
        const { error } = await supabase.from('budgets').delete().eq('id', b.id);
        if (error) return alert(error.message);
        await logAudit('delete','budgets', b.id, { description: b.description });
        renderTabContent('Draft Budget');
      });
    }
    pnlTb.appendChild(tr);
  });
  pnlTable.appendChild(pnlTb);
  pnlCard.appendChild(pnlTable);
  container.appendChild(pnlCard);
}

/* -------------------------
   Actual Budget (admin-only)
   ------------------------- */
async function renderActualBudgetTab() {
  if (!isAdmin) return tabContent.innerHTML = '<div class="muted">Actual Budget is admin-only.</div>';
  const { data: budgets } = await supabase.from('budgets').select('*').eq('competition_id', currentComp.id).eq('kind','actual').order('created_at', { ascending: true });
  const container = document.createElement('div');
  container.className = 'col';
  const addBtn = document.createElement('button');
  addBtn.textContent = 'Add Actual Row';
  addBtn.addEventListener('click', async () => {
    const itemType = prompt('Item type (income/expense)', 'expense');
    const description = prompt('Description', '');
    const amount = parseFloat(prompt('Amount', '0')) || 0;
    const payload = { competition_id: currentComp.id, kind: 'actual', item_type: itemType, description, amount };
    const { data, error } = await supabase.from('budgets').insert([payload]).select().single();
    if (error) return alert(error.message);
    await logAudit('insert','budgets', data.id, payload);
    renderTabContent('Actual Budget');
  });
  container.appendChild(addBtn);

  const t = document.createElement('table');
  t.innerHTML = `<thead><tr><th>Type</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead>`;
  const tb = document.createElement('tbody');
  (budgets || []).forEach(b => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(b.item_type)}</td><td>${escapeHtml(b.description||'')}</td><td>${b.amount||0}</td><td><button class="delBud danger">Delete</button></td>`;
    tr.querySelector('.delBud').addEventListener('click', async () => {
      if (!confirm('Delete?')) return;
      const { error } = await supabase.from('budgets').delete().eq('id', b.id);
      if (error) return alert(error.message);
      await logAudit('delete','budgets', b.id, { description: b.description });
      renderTabContent('Actual Budget');
    });
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  container.appendChild(t);
  tabContent.appendChild(container);
}

/* -------------------------
   Checklist tab
   ------------------------- */
async function renderChecklistTab() {
  const { data: items } = await supabase.from('checklist').select('*').eq('competition_id', currentComp.id).order('created_at', { ascending: true });
  const container = document.createElement('div');
  container.className = 'col';
  const addBtn = document.createElement('button');
  addBtn.textContent = 'Add Item';
  addBtn.addEventListener('click', async () => {
    if (!isAdmin) return alert('Only admins can add');
    const item = prompt('Item name', '');
    const person = prompt('Person in charge', '');
    const payload = { competition_id: currentComp.id, item, person_in_charge: person, progress: 'None' };
    const { data, error } = await supabase.from('checklist').insert([payload]).select().single();
    if (error) return alert(error.message);
    await logAudit('insert','checklist', data.id, payload);
    renderTabContent('Checklist');
  });
  container.appendChild(addBtn);

  const t = document.createElement('table');
  t.innerHTML = `<thead><tr><th>Item</th><th>Person</th><th>Progress</th><th>Actions</th></tr></thead>`;
  const tb = document.createElement('tbody');
  (items || []).forEach(it => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(it.item)}</td><td>${escapeHtml(it.person_in_charge||'')}</td><td>${escapeHtml(it.progress)}</td><td>${isAdmin ? '<button class="toggleProg">Toggle</button><button class="delIt danger">Delete</button>' : ''}</td>`;
    if (isAdmin) {
      tr.querySelector('.toggleProg').addEventListener('click', async () => {
        const next = it.progress === 'None' ? 'WIP' : it.progress === 'WIP' ? 'Done' : 'None';
        const { error } = await supabase.from('checklist').update({ progress: next }).eq('id', it.id);
        if (error) return alert(error.message);
        await logAudit('update','checklist', it.id, { progress: next });
        renderTabContent('Checklist');
      });
      tr.querySelector('.delIt').addEventListener('click', async () => {
        if (!confirm('Delete item?')) return;
        const { error } = await supabase.from('checklist').delete().eq('id', it.id);
        if (error) return alert(error.message);
        await logAudit('delete','checklist', it.id, { item: it.item });
        renderTabContent('Checklist');
      });
    }
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  container.appendChild(t);
  tabContent.appendChild(container);
}

/* -------------------------
   Staff tab
   ------------------------- */
async function renderStaffTab() {
  const { data: staff } = await supabase.from('staff').select('*').eq('competition_id', currentComp.id).order('created_at', { ascending: true });
  const container = document.createElement('div');
  container.className = 'col';
  const addBtn = document.createElement('button');
  addBtn.textContent = 'Add Staff';
  addBtn.addEventListener('click', async () => {
    if (!isAdmin) return alert('Only admins can add');
    const staffid = prompt('Staff ID', '');
    const name = prompt('Name', '');
    const role = prompt('Role', '');
    const payload = { competition_id: currentComp.id, staffid, name, role };
    const { data, error } = await supabase.from('staff').insert([payload]).select().single();
    if (error) return alert(error.message);
    await logAudit('insert','staff', data.id, payload);
    renderTabContent('Staff');
  });
  container.appendChild(addBtn);

  const t = document.createElement('table');
  t.innerHTML = `<thead><tr><th>Staff ID</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>`;
  const tb = document.createElement('tbody');
  (staff || []).forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.staffid||'')}</td><td>${escapeHtml(s.name||'')}</td><td>${escapeHtml(s.role||'')}</td><td>${isAdmin ? '<button class="delS danger">Delete</button>' : ''}</td>`;
    if (isAdmin) tr.querySelector('.delS').addEventListener('click', async () => {
      if (!confirm('Delete staff?')) return;
      const { error } = await supabase.from('staff').delete().eq('id', s.id);
      if (error) return alert(error.message);
      await logAudit('delete','staff', s.id, { name: s.name });
      renderTabContent('Staff');
    });
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  container.appendChild(t);
  tabContent.appendChild(container);
}

/* -------------------------
   Free text tabs (Travel, Prize, Remarks)
   ------------------------- */
async function renderFreeTab(tabName) {
  const { data } = await supabase.from('free_tabs').select('*').eq('competition_id', currentComp.id).eq('tab_name', tabName).single();
  const container = document.createElement('div');
  container.className = 'col';
  const textarea = document.createElement('textarea');
  textarea.rows = 10;
  textarea.style.width = '100%';
  textarea.value = data ? data.content || '' : '';
  container.appendChild(textarea);
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save';
  saveBtn.addEventListener('click', async () => {
    if (!isAdmin) return alert('Only admins can save');
    if (data) {
      const { error } = await supabase.from('free_tabs').update({ content: textarea.value }).eq('id', data.id);
      if (error) return alert(error.message);
      await logAudit('update','free_tabs', data.id, { tab: tabName });
    } else {
      const payload = { competition_id: currentComp.id, tab_name: tabName, content: textarea.value };
      const { data: inserted, error } = await supabase.from('free_tabs').insert([payload]).select().single();
      if (error) return alert(error.message);
      await logAudit('insert','free_tabs', inserted.id, payload);
    }
    alert('Saved');
  });
  container.appendChild(saveBtn);
  tabContent.appendChild(container);
}

/* -------------------------
   Utilities
   ------------------------- */
function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function parseJsonSafe(s) {
  try { return s ? JSON.parse(s) : {}; } catch(e) { return {}; }
}

function groupBy(arr, fn) {
  return (arr || []).reduce((acc, x) => { const k = fn(x); (acc[k] = acc[k] || []).push(x); return acc; }, {});
}

function formatDatetimeLocal(s) {
  if (!s) return '';
  try {
    const d = new Date(s);
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  } catch(e) { return ''; }
}

/* audit logging helper */
async function logAudit(action, target_table, target_id, diff = {}) {
  try {
    const userId = currentUser?.id || null;
    await supabase.from('audit_log').insert([{ user_id: userId, action, target_table, target_id, diff }]);
  } catch(e) {
    console.warn('Audit log failed', e);
  }
}

/* autosave helper (example: autosave competition name changes if admin edits inline) */
function scheduleAutosave(saveFn, delay = 1500) {
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(saveFn, delay);
}

/* initial load */
(async function init() {
  await refreshSession();
  await loadCompetitions();
  // subscribe to realtime changes for competitions
  try {
    supabase.channel('public:competitions')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'competitions' }, payload => {
        loadCompetitions();
        // if current comp changed, refresh it
        if (currentComp && payload.record && payload.record.id === currentComp.id) openCompetition(currentComp.id);
      })
      .subscribe();
  } catch(e) { console.warn('Realtime subscribe failed', e); }
})();
</script>
</body>
</html>
